#!/usr/bin/env bash
set -e  # Exit on any error

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Detect OS
OS="$(uname -s)"

# Helper functions
print_status() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

op_get() {
	f="${3:-notesPlain}"
	op item get "$2" --account "$1" --fields "$f" --format json --vault dotfiles | jq -rM '.value'
}

op_getfile() {
	f="${4:-notesPlain}"
	op --account "$1" read "op://$2/$3/$f"
}

op_account() {
	domain="${3:-my}.1password.eu"
	op account add \
		--address "$domain" \
		--email "$2" \
		--shorthand "$1"
}

stow_packages() {
  print_status "Setting up dotfiles symlinks with stow..."

  local packages_dir="./packages"
  local target_dir="${HOME}"

  if [[ ! -d "${packages_dir}" ]]; then
    print_error "Packages directory not found at ${packages_dir}"
    return 1
  fi

  # Stow each package
  for package in "${packages_dir}"/*; do
    if [[ -d "${package}" ]]; then
      local package_name
      package_name=$(basename "${package}")
      print_status "Stowing ${package_name}..."
      if stow --dir packages --adopt -v --target "${target_dir}" "${package_name}" 2>/dev/null; then
        print_success "${package_name} stowed"
      else
        print_warning "Failed to stow ${package_name} (may already be stowed)"
      fi
    fi
  done

  print_success "Dotfiles symlinks created"
}

install_runtime_packages() {
  # install stow, autosuggestions, fzf, and other dependencies
  if command -v apt-get 2>&1 >/dev/null; then
    print_status "Installing dependencies with apt-get..."
    sudo apt-get update
    sudo apt-get install -y --no-install-recommends \
      curl \
      fzf \
      gpg \
      gnupg \
      gpg-agent \
      stow \
      zsh-autosuggestions \
      zsh-syntax-highlighting
  elif command -v apk 2>&1 >/dev/null; then
    print_status "Installing dependencies with apk..."
    apk add --no-cache \
      curl \
      fzf \
      gpg \
      gnupg \
      gpg-agent \
      stow \
      zsh-autosuggestions \
      zsh-syntax-highlighting
  else
    print_error "distribution not supported"
    exit 1
  fi

  print_success "Dependencies installed successfully"
  print_success "stow version: $(stow --version)"
}

install_1password_cli() {
  print_status "Installing 1Password CLI..."
  local arch="$(dpkg --print-architecture)"

  # Add the key for the 1Password apt repository:
  curl -sS https://downloads.1password.com/linux/keys/1password.asc | sudo gpg --dearmor --output /usr/share/keyrings/1password-archive-keyring.gpg

  # Add the 1Password apt repository:
  echo "deb [arch=${arch} signed-by=/usr/share/keyrings/1password-archive-keyring.gpg] https://downloads.1password.com/linux/debian/${arch} stable main" | sudo tee /etc/apt/sources.list.d/1password.list

  # Add the debsig-verify policy:
  sudo mkdir -p /etc/debsig/policies/AC2D62742012EA22/ && \
    curl -sS https://downloads.1password.com/linux/debian/debsig/1password.pol | \
    sudo tee /etc/debsig/policies/AC2D62742012EA22/1password.pol && \
    sudo mkdir -p /usr/share/debsig/keyrings/AC2D62742012EA22 && \
    curl -sS https://downloads.1password.com/linux/keys/1password.asc | \
    sudo gpg --dearmor --output /usr/share/debsig/keyrings/AC2D62742012EA22/debsig.gpg

  # Install 1Password CLI:
  if command -v apt-get 2>&1 >/dev/null; then
    print_status "Installing 1Password CLI with apt-get..."
    sudo apt-get update
    sudo apt-get install -y --no-install-recommends 1password-cli
  elif command -v apk 2>&1 >/dev/null; then
    print_status "Installing 1Password CLI with apk..."
    apk add --no-cache 1password-cli
  else
    print_error "distribution not supported"
    exit 1
  fi
}

setup_user() {

  print_status "Setting up 1Password CLI account"
  op_account bd
  eval "$(op signin --account bd)"

  print_status "setting up key keychain"
  op_get bd GH_TOKEN token | gh auth login --with-token
  mkdir -p $HOME/.ssh

  if [[ -d /home/root/.ssh ]]; then
    cp /root/.ssh/authorized_keys $HOME/.ssh/authorized_keys
  fi

  op_get bd id_ed25519_github privateKey > $HOME/.ssh/id_ed25519
  op_get bd id_ed25519_github publicKey > $HOME/.ssh/id_ed25519.pub
  ssh-keyscan -p 22 -H github.com gist.github.com > $HOME/.ssh/known_hosts
  chmod 700 $HOME/.ssh
  chmod 600 $HOME/.ssh/*

}

print_status "Installing zoxide..."
sh ./install.d/zoxide

print_status "Installing starship prompt..."
sh ./install.d/starship --yes

print_status "Installing mise..."
sh ./install.d/mise

install_runtime_packages

install_1password_cli

stow_packages

setup_user

git restore .

print_success "Dotfiles installation complete!"